{"version":3,"sources":["../../../../../../build/webpack/plugins/terser-webpack-plugin/src/index.js"],"names":["getEcmaVersion","environment","arrowFunction","const","destructuring","forOf","module","bigIntLiteral","dynamicImport","buildError","error","file","line","Error","message","col","stack","split","slice","join","Webpack4Cache","constructor","cacheDir","SourceMapSource","RawSource","sources","getLazyHashedEtag","obj","str","source","hash","crypto","createHash","update","digest","getPromise","identifier","etag","cachedResult","cacache","get","ignoreError","undefined","JSON","parse","data","code","name","map","input","inputSourceMap","storePromise","put","stringify","TerserPlugin","options","terserOptions","parallel","optimize","compiler","compilation","assets","optimizeOptions","cache","compilerSpan","spans","terserSpan","traceChild","setAttribute","isWebpack5","traceAsyncFn","numberOfAssetsForMinify","assetsList","Object","keys","Array","from","additionalChunkAssets","reduce","acc","chunk","concat","files","assetsForMinify","Promise","all","filter","ModuleFilenameHelpers","matchObject","bind","test","res","getAsset","console","log","info","minimized","eTag","output","inputSource","numberOfWorkers","Math","min","availableNumberOfCores","initializedWorker","getWorker","Worker","path","__dirname","numWorkers","enableWorkerThreads","getStdout","pipe","process","stdout","getStderr","stderr","limit","Infinity","scheduledTasks","asset","push","minifySpan","sourceFromInputSource","sourceAndMap","Buffer","isBuffer","toString","javascriptModule","minify","errors","newInfo","updateAsset","end","apply","webpack","ecma","pluginName","hooks","tap","getCache","handleHashForChunk","JSModulesHooks","javascript","JavascriptModulesPlugin","getCompilationHooks","chunkHash","hasRuntime","processAssets","tapPromise","stage","Compilation","PROCESS_ASSETS_STAGE_OPTIMIZE_SIZE","statsPrinter","stats","print","for","green","formatFlag","mainTemplate","hashForChunk","chunkTemplate","optimizeChunkAssets"],"mappings":"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","sourcesContent":["// @ts-nocheck\nimport * as path from 'path'\nimport {\n  webpack,\n  ModuleFilenameHelpers,\n  isWebpack5,\n  sources,\n} from 'next/dist/compiled/webpack/webpack'\nimport pLimit from 'p-limit'\nimport { Worker } from 'jest-worker'\nimport crypto from 'crypto'\nimport cacache from 'next/dist/compiled/cacache'\nimport { spans } from '../../profiling-plugin'\n\nfunction getEcmaVersion(environment) {\n  // ES 6th\n  if (\n    environment.arrowFunction ||\n    environment.const ||\n    environment.destructuring ||\n    environment.forOf ||\n    environment.module\n  ) {\n    return 2015\n  }\n\n  // ES 11th\n  if (environment.bigIntLiteral || environment.dynamicImport) {\n    return 2020\n  }\n\n  return 5\n}\n\nfunction buildError(error, file) {\n  if (error.line) {\n    return new Error(\n      `${file} from Terser\\n${error.message} [${file}:${error.line},${\n        error.col\n      }]${\n        error.stack ? `\\n${error.stack.split('\\n').slice(1).join('\\n')}` : ''\n      }`\n    )\n  }\n\n  if (error.stack) {\n    return new Error(`${file} from Terser\\n${error.message}\\n${error.stack}`)\n  }\n\n  return new Error(`${file} from Terser\\n${error.message}`)\n}\n\nclass Webpack4Cache {\n  constructor(cacheDir, { SourceMapSource, RawSource }) {\n    this.cacheDir = cacheDir\n    this.sources = { SourceMapSource, RawSource }\n  }\n  getLazyHashedEtag(obj) {\n    let str\n    if (obj.source) {\n      str = obj.source()\n    }\n    const hash = crypto.createHash('md4')\n    hash.update(str ? str : obj)\n    return hash.digest('base64')\n  }\n\n  async getPromise(identifier, etag) {\n    let cachedResult\n\n    try {\n      cachedResult = await cacache.get(this.cacheDir, etag)\n    } catch (ignoreError) {\n      // eslint-disable-next-line no-undefined\n      return undefined\n    }\n\n    cachedResult = JSON.parse(cachedResult.data)\n\n    const { code, name, map, input, inputSourceMap } = cachedResult\n\n    let source\n\n    if (map) {\n      source = new this.sources.SourceMapSource(\n        code,\n        name,\n        map,\n        input,\n        inputSourceMap,\n        true\n      )\n    } else {\n      source = new this.sources.RawSource(code)\n    }\n\n    return { source }\n  }\n\n  async storePromise(identifier, etag, data) {\n    await cacache.put(this.cacheDir, etag, JSON.stringify(data))\n  }\n}\n\nclass TerserPlugin {\n  constructor(options = {}) {\n    const { cacheDir, terserOptions = {}, parallel } = options\n\n    this.options = {\n      cacheDir,\n      parallel,\n      terserOptions,\n    }\n  }\n\n  async optimize(\n    compiler,\n    compilation,\n    assets,\n    optimizeOptions,\n    cache,\n    { SourceMapSource, RawSource }\n  ) {\n    const compilerSpan = spans.get(compiler)\n    const terserSpan = compilerSpan.traceChild('terser-webpack-plugin-optimize')\n    terserSpan.setAttribute('webpackVersion', isWebpack5 ? 5 : 4)\n    terserSpan.setAttribute('compilationName', compilation.name)\n\n    return terserSpan.traceAsyncFn(async () => {\n      let numberOfAssetsForMinify = 0\n      const assetsList = isWebpack5\n        ? Object.keys(assets)\n        : [\n            ...Array.from(compilation.additionalChunkAssets || []),\n            ...Array.from(assets).reduce((acc, chunk) => {\n              return acc.concat(Array.from(chunk.files || []))\n            }, []),\n          ]\n\n      const assetsForMinify = await Promise.all(\n        assetsList\n          .filter((name) => {\n            if (\n              !ModuleFilenameHelpers.matchObject.bind(\n                // eslint-disable-next-line no-undefined\n                undefined,\n                { test: /\\.[cm]?js(\\?.*)?$/i }\n              )(name)\n            ) {\n              return false\n            }\n\n            const res = compilation.getAsset(name)\n            if (!res) {\n              console.log(name)\n              return false\n            }\n\n            const { info } = res\n\n            // Skip double minimize assets from child compilation\n            if (info.minimized) {\n              return false\n            }\n\n            return true\n          })\n          .map(async (name) => {\n            const { info, source } = compilation.getAsset(name)\n\n            const eTag = cache.getLazyHashedEtag(source)\n            const output = await cache.getPromise(name, eTag)\n\n            if (!output) {\n              numberOfAssetsForMinify += 1\n            }\n\n            return { name, info, inputSource: source, output, eTag }\n          })\n      )\n\n      const numberOfWorkers = Math.min(\n        numberOfAssetsForMinify,\n        optimizeOptions.availableNumberOfCores\n      )\n\n      let initializedWorker\n\n      // eslint-disable-next-line consistent-return\n      const getWorker = () => {\n        if (initializedWorker) {\n          return initializedWorker\n        }\n\n        initializedWorker = new Worker(path.join(__dirname, './minify.js'), {\n          numWorkers: numberOfWorkers,\n          enableWorkerThreads: true,\n        })\n\n        initializedWorker.getStdout().pipe(process.stdout)\n        initializedWorker.getStderr().pipe(process.stderr)\n\n        return initializedWorker\n      }\n\n      const limit = pLimit(\n        numberOfAssetsForMinify > 0 ? numberOfWorkers : Infinity\n      )\n      const scheduledTasks = []\n\n      for (const asset of assetsForMinify) {\n        scheduledTasks.push(\n          limit(async () => {\n            const { name, inputSource, info, eTag } = asset\n            let { output } = asset\n\n            const minifySpan = terserSpan.traceChild('minify-fs')\n            minifySpan.setAttribute('name', name)\n            minifySpan.setAttribute(\n              'cache',\n              typeof output === 'undefined' ? 'MISS' : 'HIT'\n            )\n\n            return minifySpan.traceAsyncFn(async () => {\n              if (!output) {\n                const {\n                  source: sourceFromInputSource,\n                  map: inputSourceMap,\n                } = inputSource.sourceAndMap()\n\n                const input = Buffer.isBuffer(sourceFromInputSource)\n                  ? sourceFromInputSource.toString()\n                  : sourceFromInputSource\n\n                const options = {\n                  name,\n                  input,\n                  inputSourceMap,\n                  terserOptions: { ...this.options.terserOptions },\n                }\n\n                if (typeof options.terserOptions.module === 'undefined') {\n                  if (typeof info.javascriptModule !== 'undefined') {\n                    options.terserOptions.module = info.javascriptModule\n                  } else if (/\\.mjs(\\?.*)?$/i.test(name)) {\n                    options.terserOptions.module = true\n                  } else if (/\\.cjs(\\?.*)?$/i.test(name)) {\n                    options.terserOptions.module = false\n                  }\n                }\n\n                try {\n                  output = await getWorker().minify(options)\n                } catch (error) {\n                  compilation.errors.push(buildError(error, name))\n\n                  return\n                }\n\n                if (output.map) {\n                  output.source = new SourceMapSource(\n                    output.code,\n                    name,\n                    output.map,\n                    input,\n                    /** @type {SourceMapRawSourceMap} */ (inputSourceMap),\n                    true\n                  )\n                } else {\n                  output.source = new RawSource(output.code)\n                }\n\n                if (isWebpack5) {\n                  await cache.storePromise(name, eTag, {\n                    source: output.source,\n                  })\n                } else {\n                  await cache.storePromise(name, eTag, {\n                    code: output.code,\n                    map: output.map,\n                    name,\n                    input,\n                    inputSourceMap,\n                  })\n                }\n              }\n\n              /** @type {AssetInfo} */\n              const newInfo = { minimized: true }\n              const { source } = output\n\n              compilation.updateAsset(name, source, newInfo)\n            })\n          })\n        )\n      }\n\n      await Promise.all(scheduledTasks)\n\n      if (initializedWorker) {\n        await initializedWorker.end()\n      }\n    })\n  }\n\n  /**\n   * @param {Compiler} compiler\n   * @returns {void}\n   */\n  apply(compiler) {\n    const { SourceMapSource, RawSource } = compiler?.webpack?.sources || sources\n    const { output } = compiler.options\n\n    if (typeof this.options.terserOptions.ecma === 'undefined') {\n      this.options.terserOptions.ecma = getEcmaVersion(output.environment || {})\n    }\n\n    const pluginName = this.constructor.name\n    const availableNumberOfCores = this.options.parallel\n\n    compiler.hooks.compilation.tap(pluginName, (compilation) => {\n      // Don't run minifier against mini-css-extract-plugin\n      if (compilation.name !== 'client' && compilation.name !== 'server') {\n        return\n      }\n\n      const cache = isWebpack5\n        ? compilation.getCache('TerserWebpackPlugin')\n        : new Webpack4Cache(this.options.cacheDir, {\n            SourceMapSource,\n            RawSource,\n          })\n\n      const handleHashForChunk = (hash, chunk) => {\n        // increment 'c' to invalidate cache\n        hash.update('c')\n      }\n\n      if (isWebpack5) {\n        const JSModulesHooks = webpack.javascript.JavascriptModulesPlugin.getCompilationHooks(\n          compilation\n        )\n        JSModulesHooks.chunkHash.tap(pluginName, (chunk, hash) => {\n          if (!chunk.hasRuntime()) return\n          return handleHashForChunk(hash, chunk)\n        })\n\n        compilation.hooks.processAssets.tapPromise(\n          {\n            name: pluginName,\n            stage: webpack.Compilation.PROCESS_ASSETS_STAGE_OPTIMIZE_SIZE,\n          },\n          (assets) =>\n            this.optimize(\n              compiler,\n              compilation,\n              assets,\n              {\n                availableNumberOfCores,\n              },\n              cache,\n              { SourceMapSource, RawSource }\n            )\n        )\n\n        compilation.hooks.statsPrinter.tap(pluginName, (stats) => {\n          stats.hooks.print\n            .for('asset.info.minimized')\n            .tap('terser-webpack-plugin', (minimized, { green, formatFlag }) =>\n              // eslint-disable-next-line no-undefined\n              minimized ? green(formatFlag('minimized')) : undefined\n            )\n        })\n      } else {\n        compilation.mainTemplate.hooks.hashForChunk.tap(\n          pluginName,\n          handleHashForChunk\n        )\n        compilation.chunkTemplate.hooks.hashForChunk.tap(\n          pluginName,\n          handleHashForChunk\n        )\n\n        compilation.hooks.optimizeChunkAssets.tapPromise(\n          pluginName,\n          async (assets) => {\n            return await this.optimize(\n              compiler,\n              compilation,\n              assets,\n              {\n                availableNumberOfCores,\n              },\n              cache,\n              { SourceMapSource, RawSource }\n            )\n          }\n        )\n      }\n    })\n  }\n}\n\nexport default TerserPlugin\n"]}