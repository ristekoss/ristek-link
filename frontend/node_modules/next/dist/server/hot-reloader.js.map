{"version":3,"sources":["../../server/hot-reloader.ts"],"names":["renderScriptError","res","error","verbose","setHeader","code","statusCode","end","console","stack","addCorsSupport","req","isApiRoute","url","match","API_ROUTE","preflight","headers","origin","method","writeHead","matchNextPageBundleRequest","findEntryModule","issuer","erroredPages","compilation","failedPages","errors","entryModule","name","enhancedName","push","HotReloader","constructor","dir","config","pagesDir","buildId","previewProps","rewrites","middlewares","webpackHotMiddleware","stats","serverStats","clientError","serverError","serverPrevDocumentHash","prevChunkNames","onDemandEntries","watcher","run","parsedUrl","handlePageBundleRequest","pageBundleRes","parsedPageBundleUrl","pathname","params","decodedPagePath","path","map","param","decodeURIComponent","join","_","err","Error","page","BLOCKED_PAGES","indexOf","ensurePage","finished","getCompilationErrors","length","fn","Promise","resolve","reject","clean","distDir","getWebpackConfig","pagePaths","all","pageExtensions","pages","filter","i","entrypoints","dev","isServer","client","server","start","configs","defaultEntry","entry","args","isClientCompilation","Object","keys","entries","serverBundlePath","clientBundlePath","absolutePagePath","pageExists","status","BUILDING","pageLoaderOpts","multiCompiler","compilers","changedClientPages","Set","changedServerPages","prevClientPageHashes","Map","prevServerPageHashes","trackPageChanges","pageHashMap","changedItems","forEach","key","startsWith","chunks","chunk","id","prevHash","get","hash","add","set","hooks","emit","tap","failed","done","serverOnlyChanges","clear","send","event","pg","substr","documentChunk","namedChunks","warn","chunkNames","addedPages","diff","removedPages","size","addedPage","removedPage","WebpackHotMiddleware","booted","watch","watchOptions","_err","middleware","isWebpack5","rootDirectory","stop","close","normalizedPage","hasErrors","action","publish","data","a","b","v","has"],"mappings":"wGAAA,kEAGA,+CACA,0BAEA,2DACA,yCACA,uCACA,8EACA,2CACA,wDACA,wDAEA,oDACA,kDACA,wFAIA,4EAIA,+GACA,kDAEA,wCACA,qC,w4BAIO,cAAeA,CAAAA,iBAAf,CACLC,GADK,CAELC,KAFK,CAGL,CAAEC,OAAO,CAAG,IAAZ,EAAqB,EAHhB,CAIL,CACA;AACAF,GAAG,CAACG,SAAJ,CACE,eADF,CAEE,gDAFF,EAKA,GAAKF,KAAD,CAAeG,IAAf,GAAwB,QAA5B,CAAsC,CACpCJ,GAAG,CAACK,UAAJ,CAAiB,GAAjB,CACAL,GAAG,CAACM,GAAJ,CAAQ,iBAAR,EACA,OACD,CAED,GAAIJ,OAAJ,CAAa,CACXK,OAAO,CAACN,KAAR,CAAcA,KAAK,CAACO,KAApB,EACD,CACDR,GAAG,CAACK,UAAJ,CAAiB,GAAjB,CACAL,GAAG,CAACM,GAAJ,CAAQ,sBAAR,EACD,CAED,QAASG,CAAAA,cAAT,CAAwBC,GAAxB,CAA8CV,GAA9C,CAAmE,CACjE,KAAMW,CAAAA,UAAU,CAAGD,GAAG,CAACE,GAAJ,CAASC,KAAT,CAAeC,oBAAf,CAAnB,CACA;AACA,GAAIH,UAAJ,CAAgB,CACd,MAAO,CAAEI,SAAS,CAAE,KAAb,CAAP,CACD,CAED,GAAI,CAACL,GAAG,CAACM,OAAJ,CAAYC,MAAjB,CAAyB,CACvB,MAAO,CAAEF,SAAS,CAAE,KAAb,CAAP,CACD,CAEDf,GAAG,CAACG,SAAJ,CAAc,6BAAd,CAA6CO,GAAG,CAACM,OAAJ,CAAYC,MAAzD,EACAjB,GAAG,CAACG,SAAJ,CAAc,8BAAd,CAA8C,cAA9C,EACA;AACA,GAAIO,GAAG,CAACM,OAAJ,CAAY,gCAAZ,CAAJ,CAAmD,CACjDhB,GAAG,CAACG,SAAJ,CACE,8BADF,CAEEO,GAAG,CAACM,OAAJ,CAAY,gCAAZ,CAFF,EAID,CAED,GAAIN,GAAG,CAACQ,MAAJ,GAAe,SAAnB,CAA8B,CAC5BlB,GAAG,CAACmB,SAAJ,CAAc,GAAd,EACAnB,GAAG,CAACM,GAAJ,GACA,MAAO,CAAES,SAAS,CAAE,IAAb,CAAP,CACD,CAED,MAAO,CAAEA,SAAS,CAAE,KAAb,CAAP,CACD,CAED,KAAMK,CAAAA,0BAA0B,CAAG,kBACjC,+CADiC,CAAnC,CAIA;AACA,QAASC,CAAAA,eAAT,CAAyBC,MAAzB,CAA2C,CACzC,GAAIA,MAAM,CAACA,MAAX,CAAmB,CACjB,MAAOD,CAAAA,eAAe,CAACC,MAAM,CAACA,MAAR,CAAtB,CACD,CAED,MAAOA,CAAAA,MAAP,CACD,CAED,QAASC,CAAAA,YAAT,CAAsBC,WAAtB,CAAoE,CAClE,KAAMC,CAAAA,WAAsC,CAAG,EAA/C,CACA,IAAK,KAAMxB,CAAAA,KAAX,GAAoBuB,CAAAA,WAAW,CAACE,MAAhC,CAAwC,CACtC,GAAI,CAACzB,KAAK,CAACgB,MAAX,CAAmB,CACjB,SACD,CAED,KAAMU,CAAAA,WAAW,CAAGN,eAAe,CAACpB,KAAK,CAACgB,MAAP,CAAnC,CACA,KAAM,CAAEW,IAAF,EAAWD,WAAjB,CACA,GAAI,CAACC,IAAL,CAAW,CACT,SACD,CAED;AACA,KAAMC,CAAAA,YAAY,CAAG,oCAAuBD,IAAvB,CAArB,CAEA,GAAI,CAACC,YAAL,CAAmB,CACjB,SACD,CAED,GAAI,CAACJ,WAAW,CAACI,YAAD,CAAhB,CAAgC,CAC9BJ,WAAW,CAACI,YAAD,CAAX,CAA4B,EAA5B,CACD,CAEDJ,WAAW,CAACI,YAAD,CAAX,CAA0BC,IAA1B,CAA+B7B,KAA/B,EACD,CAED,MAAOwB,CAAAA,WAAP,CACD,CAEc,KAAMM,CAAAA,WAAY,CAkB/BC,WAAW,CACTC,GADS,CAET,CACEC,MADF,CAEEC,QAFF,CAGEC,OAHF,CAIEC,YAJF,CAKEC,QALF,CAFS,CAeT,MAhCML,GAgCN,aA/BMG,OA+BN,aA9BMG,WA8BN,aA7BMJ,QA6BN,aA5BMK,oBA4BN,aA3BMN,MA2BN,aA1BMO,KA0BN,aAzBMC,WAyBN,aAxBMC,WAwBN,CAxBkC,IAwBlC,MAvBMC,WAuBN,CAvBkC,IAuBlC,MAtBMC,sBAsBN,aArBMC,cAqBN,aApBMC,eAoBN,aAnBMV,YAmBN,aAlBMW,OAkBN,aAjBMV,QAiBN,QACA,KAAKF,OAAL,CAAeA,OAAf,CACA,KAAKH,GAAL,CAAWA,GAAX,CACA,KAAKM,WAAL,CAAmB,EAAnB,CACA,KAAKJ,QAAL,CAAgBA,QAAhB,CACA,KAAKK,oBAAL,CAA4B,IAA5B,CACA,KAAKC,KAAL,CAAa,IAAb,CACA,KAAKC,WAAL,CAAmB,IAAnB,CACA,KAAKG,sBAAL,CAA8B,IAA9B,CAEA,KAAKX,MAAL,CAAcA,MAAd,CACA,KAAKG,YAAL,CAAoBA,YAApB,CACA,KAAKC,QAAL,CAAgBA,QAAhB,CACD,CAED,KAAaW,CAAAA,GAAb,CACEvC,GADF,CAEEV,GAFF,CAGEkD,SAHF,CAIgC,CAC9B;AACA;AACA;AACA;AACA,KAAM,CAAEnC,SAAF,EAAgBN,cAAc,CAACC,GAAD,CAAMV,GAAN,CAApC,CACA,GAAIe,SAAJ,CAAe,CACb,MAAO,EAAP,CACD,CAED;AACA;AACA;AACA;AACA,KAAMoC,CAAAA,uBAAuB,CAAG,MAC9BC,aAD8B,CAE9BC,mBAF8B,GAGG,CACjC,KAAM,CAAEC,QAAF,EAAeD,mBAArB,CACA,KAAME,CAAAA,MAAiC,CAAGnC,0BAA0B,CAClEkC,QADkE,CAApE,CAGA,GAAI,CAACC,MAAL,CAAa,CACX,MAAO,EAAP,CACD,CAED,GAAIC,CAAAA,eAAJ,CAEA,GAAI,CACFA,eAAe,CAAI,IAAGD,MAAM,CAACE,IAAP,CACnBC,GADmB,CACdC,KAAD,EAAWC,kBAAkB,CAACD,KAAD,CADd,EAEnBE,IAFmB,CAEd,GAFc,CAET,EAFb,CAGD,CAAC,MAAOC,CAAP,CAAU,CACV,KAAMC,CAAAA,GAA8B,CAAG,GAAIC,CAAAA,KAAJ,CACrC,wBADqC,CAAvC,CAGAD,GAAG,CAAC3D,IAAJ,CAAW,eAAX,CACA,KAAM2D,CAAAA,GAAN,CACD,CAED,KAAME,CAAAA,IAAI,CAAG,2CAAoBT,eAApB,CAAb,CAEA,GAAIS,IAAI,GAAK,SAAT,EAAsBC,0BAAcC,OAAd,CAAsBF,IAAtB,IAAgC,CAAC,CAA3D,CAA8D,CAC5D,GAAI,CACF,KAAM,MAAKG,UAAL,CAAgBH,IAAhB,CAAN,CACD,CAAC,MAAOhE,KAAP,CAAc,CACd,KAAMF,CAAAA,iBAAiB,CAACqD,aAAD,CAAgBnD,KAAhB,CAAvB,CACA,MAAO,CAAEoE,QAAQ,CAAE,IAAZ,CAAP,CACD,CAED,KAAM3C,CAAAA,MAAM,CAAG,KAAM,MAAK4C,oBAAL,CAA0BL,IAA1B,CAArB,CACA,GAAIvC,MAAM,CAAC6C,MAAP,CAAgB,CAApB,CAAuB,CACrB,KAAMxE,CAAAA,iBAAiB,CAACqD,aAAD,CAAgB1B,MAAM,CAAC,CAAD,CAAtB,CAA2B,CAAExB,OAAO,CAAE,KAAX,CAA3B,CAAvB,CACA,MAAO,CAAEmE,QAAQ,CAAE,IAAZ,CAAP,CACD,CACF,CAED,MAAO,EAAP,CACD,CA5CD,CA8CA,KAAM,CAAEA,QAAF,EAAe,KAAMlB,CAAAA,uBAAuB,CAACnD,GAAD,CAAMkD,SAAN,CAAlD,CAEA,IAAK,KAAMsB,CAAAA,EAAX,GAAiB,MAAKjC,WAAtB,CAAmC,CACjC,KAAM,IAAIkC,CAAAA,OAAJ,CAAkB,CAACC,OAAD,CAAUC,MAAV,GAAqB,CAC3CH,EAAE,CAAC9D,GAAD,CAAMV,GAAN,CAAY+D,GAAD,EAAgB,CAC3B,GAAIA,GAAJ,CAAS,MAAOY,CAAAA,MAAM,CAACZ,GAAD,CAAb,CACTW,OAAO,GACR,CAHC,CAAF,CAID,CALK,CAAN,CAMD,CAED,MAAO,CAAEL,QAAF,CAAP,CACD,CAED,KAAcO,CAAAA,KAAd,EAAqC,CACnC,MAAO,qCAAgB,eAAK,KAAK3C,GAAV,CAAe,KAAKC,MAAL,CAAY2C,OAA3B,CAAhB,CAAqD,QAArD,CAAP,CACD,CAED,KAAcC,CAAAA,gBAAd,EAAiC,CAC/B,KAAMC,CAAAA,SAAS,CAAG,KAAMN,CAAAA,OAAO,CAACO,GAAR,CAAY,CAClC,+BAAa,KAAK7C,QAAlB,CAA4B,OAA5B,CAAqC,KAAKD,MAAL,CAAY+C,cAAjD,CADkC,CAElC,+BAAa,KAAK9C,QAAlB,CAA4B,YAA5B,CAA0C,KAAKD,MAAL,CAAY+C,cAAtD,CAFkC,CAAZ,CAAxB,CAKA,KAAMC,CAAAA,KAAK,CAAG,gCACZH,SAAS,CAACI,MAAV,CAAkBC,CAAD,EAAOA,CAAC,GAAK,IAA9B,CADY,CAEZ,KAAKlD,MAAL,CAAY+C,cAFA,CAAd,CAIA,KAAMI,CAAAA,WAAW,CAAG,+BAClBH,KADkB,CAElB,QAFkB,CAGlB,KAAK9C,OAHa,CAIlB,KAAKC,YAJa,CAKlB,KAAKH,MALa,CAMlB,EANkB,CAApB,CASA,MAAOuC,CAAAA,OAAO,CAACO,GAAR,CAAY,CACjB,2BAAqB,KAAK/C,GAA1B,CAA+B,CAC7BqD,GAAG,CAAE,IADwB,CAE7BC,QAAQ,CAAE,KAFmB,CAG7BrD,MAAM,CAAE,KAAKA,MAHgB,CAI7BE,OAAO,CAAE,KAAKA,OAJe,CAK7BD,QAAQ,CAAE,KAAKA,QALc,CAM7BG,QAAQ,CAAE,KAAKA,QANc,CAO7B+C,WAAW,CAAEA,WAAW,CAACG,MAPI,CAA/B,CADiB,CAUjB,2BAAqB,KAAKvD,GAA1B,CAA+B,CAC7BqD,GAAG,CAAE,IADwB,CAE7BC,QAAQ,CAAE,IAFmB,CAG7BrD,MAAM,CAAE,KAAKA,MAHgB,CAI7BE,OAAO,CAAE,KAAKA,OAJe,CAK7BD,QAAQ,CAAE,KAAKA,QALc,CAM7BG,QAAQ,CAAE,KAAKA,QANc,CAO7B+C,WAAW,CAAEA,WAAW,CAACI,MAPI,CAA/B,CAViB,CAAZ,CAAP,CAoBD,CAED,KAAaC,CAAAA,KAAb,EAAoC,CAClC,KAAM,MAAKd,KAAL,EAAN,CAEA,KAAMe,CAAAA,OAAO,CAAG,KAAM,MAAKb,gBAAL,EAAtB,CAEA,IAAK,KAAM5C,CAAAA,MAAX,GAAqByD,CAAAA,OAArB,CAA8B,CAC5B,KAAMC,CAAAA,YAAY,CAAG1D,MAAM,CAAC2D,KAA5B,CACA3D,MAAM,CAAC2D,KAAP,CAAe,MAAO,GAAGC,IAAV,GAAmB,CAChC;AACA,KAAMT,CAAAA,WAAW,CAAG,KAAMO,CAAAA,YAAY,CAAC,GAAGE,IAAJ,CAAtC,CAEA,KAAMC,CAAAA,mBAAmB,CAAG7D,MAAM,CAACN,IAAP,GAAgB,QAA5C,CAEA,KAAM6C,CAAAA,OAAO,CAACO,GAAR,CACJgB,MAAM,CAACC,IAAP,CAAYC,6BAAZ,EAAqBxC,GAArB,CAAyB,KAAOO,CAAAA,IAAP,EAAgB,CACvC,GAAI8B,mBAAmB,EAAI9B,IAAI,CAACpD,KAAL,CAAWC,oBAAX,CAA3B,CAAkD,CAChD,OACD,CACD,KAAM,CACJqF,gBADI,CAEJC,gBAFI,CAGJC,gBAHI,EAIFH,8BAAQjC,IAAR,CAJJ,CAKA,KAAMqC,CAAAA,UAAU,CAAG,KAAM,6BAAYD,gBAAZ,CAAzB,CACA,GAAI,CAACC,UAAL,CAAiB,CACf;AACA,MAAOJ,+BAAQjC,IAAR,CAAP,CACA,OACD,CAEDiC,8BAAQjC,IAAR,EAAcsC,MAAd,CAAuBC,8BAAvB,CACA,KAAMC,CAAAA,cAAwC,CAAG,CAC/CxC,IAD+C,CAE/CoC,gBAF+C,CAAjD,CAKAhB,WAAW,CACTU,mBAAmB,CAAGK,gBAAH,CAAsBD,gBADhC,CAAX,CAEIJ,mBAAmB,CAClB,4BAA2B,2BAAUU,cAAV,CAA0B,GADnC,CAEnBJ,gBAJJ,CAKD,CA3BD,CADI,CAAN,CA+BA,MAAOhB,CAAAA,WAAP,CACD,CAtCD,CAuCD,CAED,KAAMqB,CAAAA,aAAa,CAAG,qBAAQf,OAAR,CAAtB,CAEA,2BAAee,aAAa,CAACC,SAAd,CAAwB,CAAxB,CAAf,CAA2CD,aAAa,CAACC,SAAd,CAAwB,CAAxB,CAA3C,EAEA;AACA;AACA,KAAMC,CAAAA,kBAAkB,CAAG,GAAIC,CAAAA,GAAJ,EAA3B,CACA,KAAMC,CAAAA,kBAAkB,CAAG,GAAID,CAAAA,GAAJ,EAA3B,CACA,KAAME,CAAAA,oBAAoB,CAAG,GAAIC,CAAAA,GAAJ,EAA7B,CACA,KAAMC,CAAAA,oBAAoB,CAAG,GAAID,CAAAA,GAAJ,EAA7B,CAEA,KAAME,CAAAA,gBAAgB,CAAG,CACvBC,WADuB,CAEvBC,YAFuB,GAGnB3E,KAAD,EAA4C,CAC/CA,KAAK,CAAC4C,WAAN,CAAkBgC,OAAlB,CAA0B,CAACxB,KAAD,CAAQyB,GAAR,GAAgB,CACxC,GAAIA,GAAG,CAACC,UAAJ,CAAe,QAAf,CAAJ,CAA8B,CAC5B1B,KAAK,CAAC2B,MAAN,CAAaH,OAAb,CAAsBI,KAAD,EAAgB,CACnC,GAAIA,KAAK,CAACC,EAAN,GAAaJ,GAAjB,CAAsB,CACpB,KAAMK,CAAAA,QAAQ,CAAGR,WAAW,CAACS,GAAZ,CAAgBN,GAAhB,CAAjB,CAEA,GAAIK,QAAQ,EAAIA,QAAQ,GAAKF,KAAK,CAACI,IAAnC,CAAyC,CACvCT,YAAY,CAACU,GAAb,CAAiBR,GAAjB,EACD,CACDH,WAAW,CAACY,GAAZ,CAAgBT,GAAhB,CAAqBG,KAAK,CAACI,IAA3B,EACD,CACF,CATD,EAUD,CACF,CAbD,EAcD,CAlBD,CAoBAnB,aAAa,CAACC,SAAd,CAAwB,CAAxB,EAA2BqB,KAA3B,CAAiCC,IAAjC,CAAsCC,GAAtC,CACE,4BADF,CAEEhB,gBAAgB,CAACH,oBAAD,CAAuBH,kBAAvB,CAFlB,EAIAF,aAAa,CAACC,SAAd,CAAwB,CAAxB,EAA2BqB,KAA3B,CAAiCC,IAAjC,CAAsCC,GAAtC,CACE,4BADF,CAEEhB,gBAAgB,CAACD,oBAAD,CAAuBH,kBAAvB,CAFlB,EAKA;AACAJ,aAAa,CAACC,SAAd,CAAwB,CAAxB,EAA2BqB,KAA3B,CAAiCG,MAAjC,CAAwCD,GAAxC,CACE,4BADF,CAEGnE,GAAD,EAAgB,CACd,KAAKnB,WAAL,CAAmBmB,GAAnB,CACA,KAAKrB,WAAL,CAAmB,IAAnB,CACD,CALH,EAOAgE,aAAa,CAACC,SAAd,CAAwB,CAAxB,EAA2BqB,KAA3B,CAAiCI,IAAjC,CAAsCF,GAAtC,CACE,4BADF,CAEGzF,KAAD,EAAW,CACT,KAAKG,WAAL,CAAmB,IAAnB,CACA,KAAKF,WAAL,CAAmBD,KAAnB,CAEA,KAAM4F,CAAAA,iBAAiB,CAAG,sBACxBvB,kBADwB,CAExBF,kBAFwB,CAA1B,CAIAA,kBAAkB,CAAC0B,KAAnB,GACAxB,kBAAkB,CAACwB,KAAnB,GAEA,GAAID,iBAAiB,CAAC9D,MAAlB,CAA2B,CAA/B,CAAkC,CAChC,KAAKgE,IAAL,CAAU,CACRC,KAAK,CAAE,mBADC,CAERtD,KAAK,CAAEmD,iBAAiB,CAAC3E,GAAlB,CAAuB+E,EAAD,EAC3B,2CAAoBA,EAAE,CAACC,MAAH,CAAU,QAAQnE,MAAlB,CAApB,CADK,CAFC,CAAV,EAMD,CAED,KAAM,CAAE/C,WAAF,EAAkBiB,KAAxB,CAEA;AACA;AACA,KAAMkG,CAAAA,aAAa,CAAGnH,WAAW,CAACoH,WAAZ,CAAwBhB,GAAxB,CAA4B,iBAA5B,CAAtB,CACA;AACA,GAAI,CAACe,aAAL,CAAoB,CAClBpI,OAAO,CAACsI,IAAR,CAAa,8BAAb,EACA,OACD,CAED;AACA,GAAI,KAAKhG,sBAAL,GAAgC,IAApC,CAA0C,CACxC,KAAKA,sBAAL,CAA8B8F,aAAa,CAACd,IAA5C,CACA,OACD,CAED;AACA,GAAIc,aAAa,CAACd,IAAd,GAAuB,KAAKhF,sBAAhC,CAAwD,CACtD,OACD,CAED;AACA,KAAK0F,IAAL,CAAU,YAAV,EACA,KAAK1F,sBAAL,CAA8B8F,aAAa,CAACd,IAA5C,CACD,CA/CH,EAkDAnB,aAAa,CAACC,SAAd,CAAwB,CAAxB,EAA2BqB,KAA3B,CAAiCG,MAAjC,CAAwCD,GAAxC,CACE,4BADF,CAEGnE,GAAD,EAAgB,CACd,KAAKpB,WAAL,CAAmBoB,GAAnB,CACA,KAAKtB,KAAL,CAAa,IAAb,CACD,CALH,EAOAiE,aAAa,CAACC,SAAd,CAAwB,CAAxB,EAA2BqB,KAA3B,CAAiCI,IAAjC,CAAsCF,GAAtC,CACE,4BADF,CAEGzF,KAAD,EAAW,CACT,KAAKE,WAAL,CAAmB,IAAnB,CACA,KAAKF,KAAL,CAAaA,KAAb,CAEA,KAAM,CAAEjB,WAAF,EAAkBiB,KAAxB,CACA,KAAMqG,CAAAA,UAAU,CAAG,GAAIjC,CAAAA,GAAJ,CACjB,CAAC,GAAGrF,WAAW,CAACoH,WAAZ,CAAwB3C,IAAxB,EAAJ,EAAoCd,MAApC,CACGvD,IAAD,EAAU,CAAC,CAAC,oCAAuBA,IAAvB,CADd,CADiB,CAAnB,CAMA,GAAI,KAAKkB,cAAT,CAAyB,CACvB;AACA;AACA,KAAMiG,CAAAA,UAAU,CAAGC,IAAI,CAACF,UAAD,CAAa,KAAKhG,cAAlB,CAAvB,CACA,KAAMmG,CAAAA,YAAY,CAAGD,IAAI,CAAC,KAAKlG,cAAN,CAAuBgG,UAAvB,CAAzB,CAEA,GAAIC,UAAU,CAACG,IAAX,CAAkB,CAAtB,CAAyB,CACvB,IAAK,KAAMC,CAAAA,SAAX,GAAwBJ,CAAAA,UAAxB,CAAoC,CAClC,KAAM9E,CAAAA,IAAI,CAAG,oCAAuBkF,SAAvB,CAAb,CACA,KAAKZ,IAAL,CAAU,WAAV,CAAuBtE,IAAvB,EACD,CACF,CAED,GAAIgF,YAAY,CAACC,IAAb,CAAoB,CAAxB,CAA2B,CACzB,IAAK,KAAME,CAAAA,WAAX,GAA0BH,CAAAA,YAA1B,CAAwC,CACtC,KAAMhF,CAAAA,IAAI,CAAG,oCAAuBmF,WAAvB,CAAb,CACA,KAAKb,IAAL,CAAU,aAAV,CAAyBtE,IAAzB,EACD,CACF,CACF,CAED,KAAKnB,cAAL,CAAsBgG,UAAtB,CACD,CAnCH,EAsCA,KAAKtG,oBAAL,CAA4B,GAAI6G,oCAAJ,CAC1B3C,aAAa,CAACC,SAAd,CAAwB,CAAxB,CAD0B,CAA5B,CAIA,GAAI2C,CAAAA,MAAM,CAAG,KAAb,CAEA,KAAKtG,OAAL,CAAe,KAAM,IAAIyB,CAAAA,OAAJ,CAAaC,OAAD,EAAa,CAC5C,KAAM1B,CAAAA,OAAO,CAAG0D,aAAa,CAAC6C,KAAd,CACd;AACA5D,OAAO,CAACjC,GAAR,CAAaxB,MAAD,EAAYA,MAAM,CAACsH,YAA/B,CAFc,CAGd;AACCC,IAAD,EAAe,CACb,GAAI,CAACH,MAAL,CAAa,CACXA,MAAM,CAAG,IAAT,CACA5E,OAAO,CAAC1B,OAAD,CAAP,CACD,CACF,CATa,CAAhB,CAWD,CAZoB,CAArB,CAcA,KAAKD,eAAL,CAAuB,kCAAqB,KAAKC,OAA1B,CAAmC0D,aAAnC,CAAkD,CACvEvE,QAAQ,CAAE,KAAKA,QADwD,CAEvE8C,cAAc,CAAE,KAAK/C,MAAL,CAAY+C,cAF2C,CAGvE,GAAI,KAAK/C,MAAL,CAAYa,eAHuD,CAAlD,CAAvB,CASA,KAAKR,WAAL,CAAmB,CACjB;AACA,KAAKQ,eAAL,CAAqB2G,UAFJ,CAGjB,KAAKlH,oBAAL,CAA0BkH,UAHT,CAIjB,qCAAqB,CACnBC,UAAU,CAAVA,mBADmB,CAEnBC,aAAa,CAAE,KAAK3H,GAFD,CAGnBQ,KAAK,CAAE,IAAM,KAAKA,KAHC,CAInBC,WAAW,CAAE,IAAM,KAAKA,WAJL,CAArB,CAJiB,CAAnB,CAWD,CAED,KAAamH,CAAAA,IAAb,EAAmC,CACjC,MAAO,IAAIpF,CAAAA,OAAJ,CAAY,CAACC,OAAD,CAAUC,MAAV,GAAqB,CACtC,KAAK3B,OAAL,CAAa8G,KAAb,CAAoB/F,GAAD,EAAeA,GAAG,CAAGY,MAAM,CAACZ,GAAD,CAAT,CAAiBW,OAAO,EAA7D,EACD,CAFM,CAAP,CAGD,CAED,KAAaJ,CAAAA,oBAAb,CAAkCL,IAAlC,CAAgD,iBAC9C,KAAM8F,CAAAA,cAAc,CAAG,wCAAiB9F,IAAjB,CAAvB,CAEA,GAAI,KAAKtB,WAAL,EAAoB,KAAKC,WAA7B,CAA0C,CACxC,MAAO,CAAC,KAAKD,WAAL,EAAoB,KAAKC,WAA1B,CAAP,CACD,CAFD,IAEO,iBAAI,KAAKH,KAAT,SAAI,YAAYuH,SAAZ,EAAJ,CAA6B,CAClC,KAAM,CAAExI,WAAF,EAAkB,KAAKiB,KAA7B,CACA,KAAMhB,CAAAA,WAAW,CAAGF,YAAY,CAACC,WAAD,CAAhC,CAEA;AACA,GACEC,WAAW,CAACsI,cAAD,CAAX,EACAtI,WAAW,CAACsI,cAAD,CAAX,CAA4BxF,MAA5B,CAAqC,CAFvC,CAGE,CACA,MAAO9C,CAAAA,WAAW,CAACsI,cAAD,CAAlB,CACD,CAED;AACA,MAAO,MAAKtH,KAAL,CAAWjB,WAAX,CAAuBE,MAA9B,CACD,CAED,MAAO,EAAP,CACD,CAEM6G,IAAP,CAAY0B,MAAZ,CAAmC,GAAGnE,IAAtC,CAAyD,CACvD,KAAKtD,oBAAL,CAA2B0H,OAA3B,CACED,MAAM,EAAI,MAAOA,CAAAA,MAAP,GAAkB,QAA5B,CAAuCA,MAAvC,CAAgD,CAAEA,MAAF,CAAUE,IAAI,CAAErE,IAAhB,CADlD,EAGD,CAED,KAAa1B,CAAAA,UAAb,CAAwBH,IAAxB,CAAsC,CACpC;AACA,GAAIA,IAAI,GAAK,SAAT,EAAsBC,0BAAcC,OAAd,CAAsBF,IAAtB,IAAgC,CAAC,CAA3D,CAA8D,CAC5D,OACD,CACD,GAAI,KAAKrB,WAAL,EAAoB,KAAKD,WAA7B,CAA0C,CACxC,MAAO8B,CAAAA,OAAO,CAACE,MAAR,CAAe,KAAK/B,WAAL,EAAoB,KAAKD,WAAxC,CAAP,CACD,CACD,MAAO,MAAKI,eAAL,CAAqBqB,UAArB,CAAgCH,IAAhC,CAAP,CACD,CAjc8B,C,4BAocjC,QAAS+E,CAAAA,IAAT,CAAcoB,CAAd,CAA2BC,CAA3B,CAAwC,CACtC,MAAO,IAAIxD,CAAAA,GAAJ,CAAQ,CAAC,GAAGuD,CAAJ,EAAOjF,MAAP,CAAemF,CAAD,EAAO,CAACD,CAAC,CAACE,GAAF,CAAMD,CAAN,CAAtB,CAAR,CAAP,CACD","sourcesContent":["import { getOverlayMiddleware } from '@next/react-dev-overlay/lib/middleware'\nimport { NextHandleFunction } from 'connect'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport { WebpackHotMiddleware } from './hot-middleware'\nimport { join } from 'path'\nimport { UrlObject } from 'url'\nimport { webpack, isWebpack5 } from 'next/dist/compiled/webpack/webpack'\nimport { createEntrypoints, createPagesMapping } from '../build/entries'\nimport { watchCompilers } from '../build/output'\nimport getBaseWebpackConfig from '../build/webpack-config'\nimport { API_ROUTE } from '../lib/constants'\nimport { recursiveDelete } from '../lib/recursive-delete'\nimport { BLOCKED_PAGES } from '../next-server/lib/constants'\nimport { __ApiPreviewProps } from '../next-server/server/api-utils'\nimport { route } from '../next-server/server/router'\nimport { findPageFile } from './lib/find-page-file'\nimport onDemandEntryHandler, {\n  entries,\n  BUILDING,\n} from './on-demand-entry-handler'\nimport {\n  denormalizePagePath,\n  normalizePathSep,\n} from '../next-server/server/normalize-page-path'\nimport getRouteFromEntrypoint from '../next-server/server/get-route-from-entrypoint'\nimport { isWriteable } from '../build/is-writeable'\nimport { ClientPagesLoaderOptions } from '../build/webpack/loaders/next-client-pages-loader'\nimport { stringify } from 'querystring'\nimport { difference } from '../build/utils'\nimport { NextConfig } from '../next-server/server/config'\nimport { CustomRoutes } from '../lib/load-custom-routes'\n\nexport async function renderScriptError(\n  res: ServerResponse,\n  error: Error,\n  { verbose = true } = {}\n) {\n  // Asks CDNs and others to not to cache the errored page\n  res.setHeader(\n    'Cache-Control',\n    'no-cache, no-store, max-age=0, must-revalidate'\n  )\n\n  if ((error as any).code === 'ENOENT') {\n    res.statusCode = 404\n    res.end('404 - Not Found')\n    return\n  }\n\n  if (verbose) {\n    console.error(error.stack)\n  }\n  res.statusCode = 500\n  res.end('500 - Internal Error')\n}\n\nfunction addCorsSupport(req: IncomingMessage, res: ServerResponse) {\n  const isApiRoute = req.url!.match(API_ROUTE)\n  // API routes handle their own CORS headers\n  if (isApiRoute) {\n    return { preflight: false }\n  }\n\n  if (!req.headers.origin) {\n    return { preflight: false }\n  }\n\n  res.setHeader('Access-Control-Allow-Origin', req.headers.origin)\n  res.setHeader('Access-Control-Allow-Methods', 'OPTIONS, GET')\n  // Based on https://github.com/primus/access-control/blob/4cf1bc0e54b086c91e6aa44fb14966fa5ef7549c/index.js#L158\n  if (req.headers['access-control-request-headers']) {\n    res.setHeader(\n      'Access-Control-Allow-Headers',\n      req.headers['access-control-request-headers'] as string\n    )\n  }\n\n  if (req.method === 'OPTIONS') {\n    res.writeHead(200)\n    res.end()\n    return { preflight: true }\n  }\n\n  return { preflight: false }\n}\n\nconst matchNextPageBundleRequest = route(\n  '/_next/static/chunks/pages/:path*.js(\\\\.map|)'\n)\n\n// Recursively look up the issuer till it ends up at the root\nfunction findEntryModule(issuer: any): any {\n  if (issuer.issuer) {\n    return findEntryModule(issuer.issuer)\n  }\n\n  return issuer\n}\n\nfunction erroredPages(compilation: webpack.compilation.Compilation) {\n  const failedPages: { [page: string]: any[] } = {}\n  for (const error of compilation.errors) {\n    if (!error.origin) {\n      continue\n    }\n\n    const entryModule = findEntryModule(error.origin)\n    const { name } = entryModule\n    if (!name) {\n      continue\n    }\n\n    // Only pages have to be reloaded\n    const enhancedName = getRouteFromEntrypoint(name)\n\n    if (!enhancedName) {\n      continue\n    }\n\n    if (!failedPages[enhancedName]) {\n      failedPages[enhancedName] = []\n    }\n\n    failedPages[enhancedName].push(error)\n  }\n\n  return failedPages\n}\n\nexport default class HotReloader {\n  private dir: string\n  private buildId: string\n  private middlewares: any[]\n  private pagesDir: string\n  private webpackHotMiddleware: (NextHandleFunction & any) | null\n  private config: NextConfig\n  private stats: webpack.Stats | null\n  private serverStats: webpack.Stats | null\n  private clientError: Error | null = null\n  private serverError: Error | null = null\n  private serverPrevDocumentHash: string | null\n  private prevChunkNames?: Set<any>\n  private onDemandEntries: any\n  private previewProps: __ApiPreviewProps\n  private watcher: any\n  private rewrites: CustomRoutes['rewrites']\n\n  constructor(\n    dir: string,\n    {\n      config,\n      pagesDir,\n      buildId,\n      previewProps,\n      rewrites,\n    }: {\n      config: NextConfig\n      pagesDir: string\n      buildId: string\n      previewProps: __ApiPreviewProps\n      rewrites: CustomRoutes['rewrites']\n    }\n  ) {\n    this.buildId = buildId\n    this.dir = dir\n    this.middlewares = []\n    this.pagesDir = pagesDir\n    this.webpackHotMiddleware = null\n    this.stats = null\n    this.serverStats = null\n    this.serverPrevDocumentHash = null\n\n    this.config = config\n    this.previewProps = previewProps\n    this.rewrites = rewrites\n  }\n\n  public async run(\n    req: IncomingMessage,\n    res: ServerResponse,\n    parsedUrl: UrlObject\n  ): Promise<{ finished?: true }> {\n    // Usually CORS support is not needed for the hot-reloader (this is dev only feature)\n    // With when the app runs for multi-zones support behind a proxy,\n    // the current page is trying to access this URL via assetPrefix.\n    // That's when the CORS support is needed.\n    const { preflight } = addCorsSupport(req, res)\n    if (preflight) {\n      return {}\n    }\n\n    // When a request comes in that is a page bundle, e.g. /_next/static/<buildid>/pages/index.js\n    // we have to compile the page using on-demand-entries, this middleware will handle doing that\n    // by adding the page to on-demand-entries, waiting till it's done\n    // and then the bundle will be served like usual by the actual route in server/index.js\n    const handlePageBundleRequest = async (\n      pageBundleRes: ServerResponse,\n      parsedPageBundleUrl: UrlObject\n    ): Promise<{ finished?: true }> => {\n      const { pathname } = parsedPageBundleUrl\n      const params: { path: string[] } | null = matchNextPageBundleRequest(\n        pathname\n      )\n      if (!params) {\n        return {}\n      }\n\n      let decodedPagePath: string\n\n      try {\n        decodedPagePath = `/${params.path\n          .map((param) => decodeURIComponent(param))\n          .join('/')}`\n      } catch (_) {\n        const err: Error & { code?: string } = new Error(\n          'failed to decode param'\n        )\n        err.code = 'DECODE_FAILED'\n        throw err\n      }\n\n      const page = denormalizePagePath(decodedPagePath)\n\n      if (page === '/_error' || BLOCKED_PAGES.indexOf(page) === -1) {\n        try {\n          await this.ensurePage(page)\n        } catch (error) {\n          await renderScriptError(pageBundleRes, error)\n          return { finished: true }\n        }\n\n        const errors = await this.getCompilationErrors(page)\n        if (errors.length > 0) {\n          await renderScriptError(pageBundleRes, errors[0], { verbose: false })\n          return { finished: true }\n        }\n      }\n\n      return {}\n    }\n\n    const { finished } = await handlePageBundleRequest(res, parsedUrl)\n\n    for (const fn of this.middlewares) {\n      await new Promise<void>((resolve, reject) => {\n        fn(req, res, (err: Error) => {\n          if (err) return reject(err)\n          resolve()\n        })\n      })\n    }\n\n    return { finished }\n  }\n\n  private async clean(): Promise<void> {\n    return recursiveDelete(join(this.dir, this.config.distDir), /^cache/)\n  }\n\n  private async getWebpackConfig() {\n    const pagePaths = await Promise.all([\n      findPageFile(this.pagesDir, '/_app', this.config.pageExtensions),\n      findPageFile(this.pagesDir, '/_document', this.config.pageExtensions),\n    ])\n\n    const pages = createPagesMapping(\n      pagePaths.filter((i) => i !== null) as string[],\n      this.config.pageExtensions\n    )\n    const entrypoints = createEntrypoints(\n      pages,\n      'server',\n      this.buildId,\n      this.previewProps,\n      this.config,\n      []\n    )\n\n    return Promise.all([\n      getBaseWebpackConfig(this.dir, {\n        dev: true,\n        isServer: false,\n        config: this.config,\n        buildId: this.buildId,\n        pagesDir: this.pagesDir,\n        rewrites: this.rewrites,\n        entrypoints: entrypoints.client,\n      }),\n      getBaseWebpackConfig(this.dir, {\n        dev: true,\n        isServer: true,\n        config: this.config,\n        buildId: this.buildId,\n        pagesDir: this.pagesDir,\n        rewrites: this.rewrites,\n        entrypoints: entrypoints.server,\n      }),\n    ])\n  }\n\n  public async start(): Promise<void> {\n    await this.clean()\n\n    const configs = await this.getWebpackConfig()\n\n    for (const config of configs) {\n      const defaultEntry = config.entry\n      config.entry = async (...args) => {\n        // @ts-ignore entry is always a functon\n        const entrypoints = await defaultEntry(...args)\n\n        const isClientCompilation = config.name === 'client'\n\n        await Promise.all(\n          Object.keys(entries).map(async (page) => {\n            if (isClientCompilation && page.match(API_ROUTE)) {\n              return\n            }\n            const {\n              serverBundlePath,\n              clientBundlePath,\n              absolutePagePath,\n            } = entries[page]\n            const pageExists = await isWriteable(absolutePagePath)\n            if (!pageExists) {\n              // page was removed\n              delete entries[page]\n              return\n            }\n\n            entries[page].status = BUILDING\n            const pageLoaderOpts: ClientPagesLoaderOptions = {\n              page,\n              absolutePagePath,\n            }\n\n            entrypoints[\n              isClientCompilation ? clientBundlePath : serverBundlePath\n            ] = isClientCompilation\n              ? `next-client-pages-loader?${stringify(pageLoaderOpts)}!`\n              : absolutePagePath\n          })\n        )\n\n        return entrypoints\n      }\n    }\n\n    const multiCompiler = webpack(configs)\n\n    watchCompilers(multiCompiler.compilers[0], multiCompiler.compilers[1])\n\n    // Watch for changes to client/server page files so we can tell when just\n    // the server file changes and trigger a reload for GS(S)P pages\n    const changedClientPages = new Set<string>()\n    const changedServerPages = new Set<string>()\n    const prevClientPageHashes = new Map<string, string>()\n    const prevServerPageHashes = new Map<string, string>()\n\n    const trackPageChanges = (\n      pageHashMap: Map<string, string>,\n      changedItems: Set<string>\n    ) => (stats: webpack.compilation.Compilation) => {\n      stats.entrypoints.forEach((entry, key) => {\n        if (key.startsWith('pages/')) {\n          entry.chunks.forEach((chunk: any) => {\n            if (chunk.id === key) {\n              const prevHash = pageHashMap.get(key)\n\n              if (prevHash && prevHash !== chunk.hash) {\n                changedItems.add(key)\n              }\n              pageHashMap.set(key, chunk.hash)\n            }\n          })\n        }\n      })\n    }\n\n    multiCompiler.compilers[0].hooks.emit.tap(\n      'NextjsHotReloaderForClient',\n      trackPageChanges(prevClientPageHashes, changedClientPages)\n    )\n    multiCompiler.compilers[1].hooks.emit.tap(\n      'NextjsHotReloaderForServer',\n      trackPageChanges(prevServerPageHashes, changedServerPages)\n    )\n\n    // This plugin watches for changes to _document.js and notifies the client side that it should reload the page\n    multiCompiler.compilers[1].hooks.failed.tap(\n      'NextjsHotReloaderForServer',\n      (err: Error) => {\n        this.serverError = err\n        this.serverStats = null\n      }\n    )\n    multiCompiler.compilers[1].hooks.done.tap(\n      'NextjsHotReloaderForServer',\n      (stats) => {\n        this.serverError = null\n        this.serverStats = stats\n\n        const serverOnlyChanges = difference<string>(\n          changedServerPages,\n          changedClientPages\n        )\n        changedClientPages.clear()\n        changedServerPages.clear()\n\n        if (serverOnlyChanges.length > 0) {\n          this.send({\n            event: 'serverOnlyChanges',\n            pages: serverOnlyChanges.map((pg) =>\n              denormalizePagePath(pg.substr('pages'.length))\n            ),\n          })\n        }\n\n        const { compilation } = stats\n\n        // We only watch `_document` for changes on the server compilation\n        // the rest of the files will be triggered by the client compilation\n        const documentChunk = compilation.namedChunks.get('pages/_document')\n        // If the document chunk can't be found we do nothing\n        if (!documentChunk) {\n          console.warn('_document.js chunk not found')\n          return\n        }\n\n        // Initial value\n        if (this.serverPrevDocumentHash === null) {\n          this.serverPrevDocumentHash = documentChunk.hash\n          return\n        }\n\n        // If _document.js didn't change we don't trigger a reload\n        if (documentChunk.hash === this.serverPrevDocumentHash) {\n          return\n        }\n\n        // Notify reload to reload the page, as _document.js was changed (different hash)\n        this.send('reloadPage')\n        this.serverPrevDocumentHash = documentChunk.hash\n      }\n    )\n\n    multiCompiler.compilers[0].hooks.failed.tap(\n      'NextjsHotReloaderForClient',\n      (err: Error) => {\n        this.clientError = err\n        this.stats = null\n      }\n    )\n    multiCompiler.compilers[0].hooks.done.tap(\n      'NextjsHotReloaderForClient',\n      (stats) => {\n        this.clientError = null\n        this.stats = stats\n\n        const { compilation } = stats\n        const chunkNames = new Set(\n          [...compilation.namedChunks.keys()].filter(\n            (name) => !!getRouteFromEntrypoint(name)\n          )\n        )\n\n        if (this.prevChunkNames) {\n          // detect chunks which have to be replaced with a new template\n          // e.g, pages/index.js <-> pages/_error.js\n          const addedPages = diff(chunkNames, this.prevChunkNames!)\n          const removedPages = diff(this.prevChunkNames!, chunkNames)\n\n          if (addedPages.size > 0) {\n            for (const addedPage of addedPages) {\n              const page = getRouteFromEntrypoint(addedPage)\n              this.send('addedPage', page)\n            }\n          }\n\n          if (removedPages.size > 0) {\n            for (const removedPage of removedPages) {\n              const page = getRouteFromEntrypoint(removedPage)\n              this.send('removedPage', page)\n            }\n          }\n        }\n\n        this.prevChunkNames = chunkNames\n      }\n    )\n\n    this.webpackHotMiddleware = new WebpackHotMiddleware(\n      multiCompiler.compilers[0]\n    )\n\n    let booted = false\n\n    this.watcher = await new Promise((resolve) => {\n      const watcher = multiCompiler.watch(\n        // @ts-ignore webpack supports an array of watchOptions when using a multiCompiler\n        configs.map((config) => config.watchOptions!),\n        // Errors are handled separately\n        (_err: any) => {\n          if (!booted) {\n            booted = true\n            resolve(watcher)\n          }\n        }\n      )\n    })\n\n    this.onDemandEntries = onDemandEntryHandler(this.watcher, multiCompiler, {\n      pagesDir: this.pagesDir,\n      pageExtensions: this.config.pageExtensions,\n      ...(this.config.onDemandEntries as {\n        maxInactiveAge: number\n        pagesBufferLength: number\n      }),\n    })\n\n    this.middlewares = [\n      // must come before hotMiddleware\n      this.onDemandEntries.middleware,\n      this.webpackHotMiddleware.middleware,\n      getOverlayMiddleware({\n        isWebpack5,\n        rootDirectory: this.dir,\n        stats: () => this.stats,\n        serverStats: () => this.serverStats,\n      }),\n    ]\n  }\n\n  public async stop(): Promise<void> {\n    return new Promise((resolve, reject) => {\n      this.watcher.close((err: any) => (err ? reject(err) : resolve()))\n    })\n  }\n\n  public async getCompilationErrors(page: string) {\n    const normalizedPage = normalizePathSep(page)\n\n    if (this.clientError || this.serverError) {\n      return [this.clientError || this.serverError]\n    } else if (this.stats?.hasErrors()) {\n      const { compilation } = this.stats\n      const failedPages = erroredPages(compilation)\n\n      // If there is an error related to the requesting page we display it instead of the first error\n      if (\n        failedPages[normalizedPage] &&\n        failedPages[normalizedPage].length > 0\n      ) {\n        return failedPages[normalizedPage]\n      }\n\n      // If none were found we still have to show the other errors\n      return this.stats.compilation.errors\n    }\n\n    return []\n  }\n\n  public send(action?: string | any, ...args: any[]): void {\n    this.webpackHotMiddleware!.publish(\n      action && typeof action === 'object' ? action : { action, data: args }\n    )\n  }\n\n  public async ensurePage(page: string) {\n    // Make sure we don't re-build or dispose prebuilt pages\n    if (page !== '/_error' && BLOCKED_PAGES.indexOf(page) !== -1) {\n      return\n    }\n    if (this.serverError || this.clientError) {\n      return Promise.reject(this.serverError || this.clientError)\n    }\n    return this.onDemandEntries.ensurePage(page)\n  }\n}\n\nfunction diff(a: Set<any>, b: Set<any>) {\n  return new Set([...a].filter((v) => !b.has(v)))\n}\n"]}